---
format: 
  revealjs:
    css: ../../styles.css
    slide-number: true
    show-slide-number: all
    preview-links: false
    progress: true
    history: true
    hash-type: number
    theme: default
    code-block-background: true
    highlight-style: zenburn
    code-link: false
    code-copy: true
    code-line-numbers: false
    controls: true
    pagetitle: "Multilevel Modeling"
    author-meta: "Jeffrey Girard"
    semester: "Spring 2026"
    course: "PSYC 894"
    lecture: "02a"
execute:
  echo: true
  eval: true
  collapse: false
  cache: false
---

::: {.my-title}
# [Multilevel Modeling]{.blue}
Linear Modeling Review (1/2)

::: {.my-grey}
[{{< meta semester >}} | CLAS | {{< meta course >}}]{}<br />
[Jeffrey M. Girard | Lecture {{< meta lecture >}}]{}
:::

![](../../img/city-girl.svg){.absolute bottom=30 right=0 width="400"}
:::

## Roadmap

::: {.columns .pv4}

::: {.column width="60%"}
1. Simple Regression
  
2. Multiple Regression

3. Categorical Predictors
:::

::: {.column .tc .pv4 width="40%"}
{{< lif "../../icons/map.json" trigger=hover colors=secondary:#2a76dd class=rc >}}
:::

:::

# R Setup

## Load Packages

```{r}
#| message: false

# install.packages(c("easystats", "ggplot2", "marginaleffects"))
library(easystats)
library(ggplot2)
library(marginaleffects)
```

:::{.fsmaller}
#### Needs to be loaded
- [easystats]{.b .blue} will provide most of our statistical functions
- [ggplot2]{.b .blue} will provide the ability to customize our plots

#### Needs to be installed
- [marginaleffects]{.b .green} is called by easystats for estimation

:::

## Example Dataset

```{r}
data_codebook(penguins)
```

::: {.fsmaller}
*Note that this dataset is already included with recent versions of R.*
:::

# CSR
Continuous Simple Regression

## CSR Overview {.smaller}

::: {.columns .pv4}
::: {.column width="60%"}
-   [Simple regression]{.b .blue} predicts one variable $y$ from another variable $x$ using a straight line

::: {.fragment .mt1}
-   This line is defined by two parameters
    -   The [intercept]{.b .green} is the value of $y$ when $x=0$
    -   The [slope]{.b .green} is the change in $y$ expected for a change of 1 in $x$ (from $x=0$ to $x=1$)
:::

::: {.fragment .mt1}
-   We will use `lm()` to fit regression models
    -   This will solve using ordinary least squares
    -   We need to give it the [data]{.b .green} and a [formula]{.b .green}
:::
:::

::: {.column .tc .pv5 width="40%"}
{{< lif "../../icons/scatter.json" trigger=hover colors=secondary:#2a76dd class=rc >}}
:::
:::

## CSR Equation

#### Generic

$$y_i = \beta_0 + \beta_1 x_{i} + \varepsilon_{i}$$

#### Example

$$\text{MASS}_i = \beta_0 + \beta_1 \text{FLEN}_{i} + \varepsilon_i$$

## CSR Formula

#### Generic
:::{.tc}
`y ~ 1 + x`
:::

#### Example
:::{.tc}
`body_mass ~ 1 + flipper_len`
:::

## CSR Diagram {.nostretch}

![](../../diagrams/simple_regression_full.png){width="75%"}

## CSR Estimation

```{r}
csr_f <- lm(
  formula = body_mass ~ 1 + flipper_len,
  data = penguins
)
```

:::{.pv4}
```{r}
model_parameters(csr_f)
```

:::

## CSR Interpretation {.smaller}

- **Intercept** $(\beta_0 = -5780.8$, $p<.001)$<br />
The body mass (g) expected for a penguin with a flipper length of 0mm.<br />
*This is biologically impossible, suggesting we should center our predictor.*

- **Flipper Length Slope** $(\beta_1 = 49.7$, $p<.001)$<br />
The expected change in body mass (g) for every 1mm increase in flipper length.

- **Conclusion**<br />
Flipper length is significantly and positively related to body mass.

## CSR Centering

```{r}
penguins_c <- center(penguins, select = "flipper_len")
csr_f_c <- lm(formula = body_mass ~ 1 + flipper_len, data = penguins_c)
```

:::{.pv4}
```{r}
compare_parameters(csr_f, csr_f_c, select = "{estimate}{stars}")
```
:::{.fsmaller}
**Note:** The slope $(\beta_1)$ does not change. However, the intercept $(\beta_0)$ is now the expected body mass for a penguin with ***average*** flipper length.
:::
:::

## CSR Standardizing

```{r}
penguins_z <- standardize(penguins, select = c("body_mass", "flipper_len"))
csr_f_z <- lm(formula = body_mass ~ 1 + flipper_len, data = penguins_z)
```

:::{.pv4}
```{r}
compare_parameters(csr_f, csr_f_z, select = "{estimate}{stars}")
```

:::{.fsmaller}
**Note:** The intercept is now zero. The slope is now the change in body mass in **Standard Deviations (SDs)** for a 1 SD increase in flipper length.
:::
:::

## CSR Visualization

```{r}
#| fig-asp: 1
#| fig-width: 6
#| output-location: column

pred_csrf <- estimate_relation(
  model = csr_f, 
  by = "flipper_len"
)
plot(pred_csrf)
```

## Plot Customization

```{r}
#| fig-asp: 1
#| fig-width: 6.5
#| output-location: column

# Use the black-and-white theme and
# use 30pt font for all future plots
theme_set(theme_bw(base_size = 30))

plot(
  pred_csrf, 
  show_data = TRUE,
  point = list(color = "salmon"),
  line = list(linewidth = 1.5)
) +
scale_y_continuous(
  limits = c(2500, 6500)
) +
labs(
  x = "Flipper length (mm)", 
  y = "Body mass (g)"
)
```

# CMR
Continuous Multiple Regression

## CMR Overview {.smaller}

::: {.columns .pv4}
::: {.column width="60%"}
-   We can include [multiple predictors]{.b .blue} to assess the [unique effect]{.b .green} of each predictor
    -   This controls for the variance shared between predictors (collinearity)

::: {.fragment .mt1}
-   This changes the interpretation of slopes
    -   **Simple Regression:** "zero-order" or Total Effect
    -   **Multiple Regression:** "partial" or Unique Effect
    
:::
::: {.fragment .mt1}
-   Interpretation:
    -   The partial effect of a predictor is the change in $y$ expected for a change of 1 in that predictor, **while holding all other predictors constant**
:::
:::

::: {.column .tc .pv5 width="40%"}
{{< lif "../../icons/venn.json" trigger=hover colors=secondary:#2a76dd class=rc >}}
:::
:::

## CMR Equation

#### Generic
$$y_i = \beta_0 + \beta_1 x_{1i} + \beta_2 x_{2i} + \dots + \varepsilon_{i}$$

#### Example (with 2 predictors)
$$\text{MASS}_i = \beta_0 + \beta_1 \text{FLEN}_{i} + \beta_2 \text{BDEP}_{i} + \varepsilon_i$$

## CMR Formula

#### Generic
:::{.tc}
`y ~ 1 + x1 + x2 + ...`
:::

#### Example (with 2 predictors)
:::{.tc}
`body_mass ~ 1 + flipper_len + bill_dep`
:::

## CMR Diagram {.nostretch}
![](../../diagrams/multiple_regression_full.png){width="70%"}

## CMR Estimation

```{r}
#| echo: true

cmr_fb <- lm(
  formula = body_mass ~ 1 + flipper_len + bill_dep,
  data = penguins
)
```

:::{.pv4}
```{r}
#| echo: true

model_parameters(cmr_fb)
```

:::

## CMR Interpretation {.smaller}

- **Intercept** $(\beta_0 = -6541.9$, $p<.001)$<br />
The body mass (g) expected when both Flipper Length and Bill Depth are 0mm.

- **Flipper Length Partial Effect** $(\beta_1 = 51.5$, $p<.001)$<br />
The expected change in body mass (g) for every 1mm increase in Flipper Length,<br />
*holding Bill Depth constant*.

- **Bill Depth Partial Effect** $(\beta_2 = 22.6$, $p=.089)$<br />
The expected change in body mass (g) for every 1mm increase in Bill Depth,<br />
*holding Flipper Length constant*.

- **Conclusion**<br />
Flipper length is uniquely predictive of Body Mass, whereas Bill Depth is not.

## Comparing Estimates

```{r}
#| echo: true

csr_b <- lm(formula = body_mass ~ 1 + bill_dep, data = penguins)
```

:::{.pv4}
```{r}
#| echo: true
compare_parameters(csr_f, csr_b, cmr_fb, select = "{estimate}{stars}")
```

:::

:::{.fsmaller}
Notice that Bill Depth was significant on its own (`csr_b`), but loses significance when Flipper Length is added (`cmr_fb`). This is because Flipper Length "explains away" the variance.
:::

## Comparing Plots 1

:::{.columns}

:::{.column width="50%"}
```{r}
#| fig-asp: 0.75

pred_csrf <- estimate_relation(
  model = csr_f, by = "flipper_len"
)
plot(pred_csrf)
```
:::

:::{.column width="50%"}
```{r}
#| fig-asp: 0.75

pred_cmrf <- estimate_relation(
  model = cmr_fb, by = "flipper_len"
)
plot(pred_cmrf)
```
:::
:::

## Comparing Plots 2

:::{.columns}

:::{.column width="50%"}
```{r}
#| fig-asp: 0.75

pred_csrb <- estimate_relation(
  model = csr_b, by = "bill_dep"
)
plot(pred_csrb)
```
:::

:::{.column width="50%"}
```{r}
#| fig-asp: 0.75

pred_cmrb <- estimate_relation(
  model = cmr_fb, by = "bill_dep"
)
plot(pred_cmrb)
```

:::
:::

# DSR
Discrete Simple Regression

## DSR Overview {.smaller}

::: {.columns .pv4}
::: {.column width="60%"}
-   To include a discrete predictor, the model will automatically use [dummy coding]{.b .blue}
    -   This creates binary $(0/1)$ "switches"

::: {.fragment .mt1}
-   One group is chosen as the [Reference Group]{.b .green}
    -   This group is represented by the *Intercept*
    -   The slopes for other groups represent differences from the reference
:::

::: {.fragment .mt1}
-   In R, simply include a [factor]{.b .green} in the formula
    -   R treats the first level as the Reference group
    -   You can create a factor if needed using `factor()`
:::
:::

::: {.column .tc .pv5 width="40%"}
{{< lif "../../icons/theater.json" trigger=hover colors=secondary:#2a76dd class=rc >}}
:::
:::

## DSR Equation {.smaller}

#### Generic
$$y_i = \beta_0 + \beta_1 D_{1i} + \dots + \varepsilon_{i}$$

#### Example (with 3 Groups)
$$\text{MASS}_i = \beta_0 + \beta_1 \text{CHIN}_i + \beta_2 \text{GENT}_i + \varepsilon_i$$

## DSR Formula

#### Generic
:::{.tc}
`y ~ 1 + f`
:::

#### Example (with 3 Groups)
:::{.tc}
`body_mass ~ 1 + species`
:::


## DSR Diagram {.nostretch}

![](../../diagrams/categorical_regression_full3.png){width="70%"}

## DSR Data Prep

The `species` variable is already a factor!

```{r}
summary(penguins$species)
```


But if it wasn't, we would need to convert it:

```{r}
#| eval: false

penguins$species <- factor(penguins$species)
```

## DSR Estimation

```{r}
dsr_s <- lm(
  formula = body_mass ~ 1 + species,
  data = penguins
)
```

:::{.pv4}
```{r}
#| echo: true

model_parameters(dsr_s)
```

:::

## DSR Interpretation {.smaller}

- **Intercept** $(\beta_0 = 3700.7$, $p<.001)$<br />
The predicted body mass (g) for the Reference Group (Adelie).

- **Species [Chinstrap] Total Effect** $(\beta_1 = 32.4$, $p=.631)$<br />
The body mass difference between Chinstrap and Adelie.<br />
*Result:* Not significant. Chinstraps are roughly the same size as Adelies.

- **Species [Gentoo] Total Effect** $(\beta_2 = 1375.4$, $p<.001)$<br />
The body mass difference between Gentoo and Adelie.<br />
*Result:* Significant. Gentoos are much larger than Adelies.

- **What's Missing?**<br />
We know how all groups compare to Adelie, but do Chinstraps differ from Gentoos?<br />
Standard regression output doesn't tell us. We need contrasts...

## DSR Pairwise Contrasts

```{r}
estimate_contrasts(
  model = dsr_s, 
  contrast = "species", 
  comparison = "pairwise", # compare pairs of groups
  estimate = "average",
  p_adjust = "holm"
)
```

## DSR Deviation Contrasts

```{r}
estimate_contrasts(
  model = dsr_s, 
  contrast = "species",
  comparison = "meandev", # compare groups to mean of all
  estimate = "average",
  p_adjust = "holm"
)
```

## DSR Means
```{r}
pred_dsrs <- estimate_means(dsr_s, by = "species")
pred_dsrs
```


## DSR Visualization

```{r}
#| fig-asp: 1
#| fig-width: 6.5
#| output-location: column

plot(pred_dsrs) +
  labs(
    x = "Species",
    y = "Body Mass (g)"
  )
```

# MMR
Mixed Multiple Regression

## MMR Equation {.smaller}

#### Generic
$$y_i = \beta_0 + \beta_1 x_{1i} + \dots +\beta_2 D_{1i} + \dots + \varepsilon_{i}$$

#### Example (with 1 continuous predictor and 3 groups)
$$\text{MASS}_i = \beta_0 + \beta_1 \text{FLEN}_i + \beta_2 \text{CHIN}_i + \beta_3 \text{GENT}_i + \varepsilon_i$$

## MMR Formula

#### Generic
:::{.tc}
`y ~ 1 + x1 + ... + f1 + ...`
:::

#### Example (with 1 continuous and 3 groups)
:::{.tc}
`body_mass ~ 1 + flipper_len + species`
:::


## MMR Diagram

![](../../diagrams/complex_regression_full.png)

## MMR Estimation

```{r}
#| echo: true

mmr_fs <- lm(
  formula = body_mass ~ 1 + flipper_len + species,
  data = penguins
)
```

:::{.pv4}
```{r}
#| echo: true

model_parameters(mmr_fs)
```

:::

## MMR Slope Visualization

```{r}
#| fig-asp: 1
#| output-location: column

pred_mmrf <- estimate_relation(
  model = mmr_fs, 
  by = "flipper_len", 
  estimate = "average"
)
plot(pred_mmrf) +
  labs(
    x = "Flipper Length (mm)", 
    y = "Body Mass (g)", 
    subtitle = "Controlling for Species"
  )
```

## MMR Means

```{r}
pred_mmrs <- estimate_means(mmr_fs, by = "species", estimate = "average")
pred_mmrs
```

## MMR Means Visualization

```{r}
#| fig-asp: 1
#| fig-width: 6.5
#| output-location: column

plot(pred_mmrs) +
  labs(
    x = "Species", 
    y = "Body Mass (g)", 
    subtitle = "Controlling for Flipper Length"
  )
```

## MMR Pairwise Contrasts

```{r}
estimate_contrasts(
  model = mmr_fs,
  contrast = "species",
  comparison = "pairwise", # compare each group to each other group
  estimate = "average",
  p_adjust = "holm"
)
```

## MMR Deviation Contrasts

```{r}
estimate_contrasts(
  model = mmr_fs,
  contrast = "species",
  comparison = "meandev", # compare each group to the mean of all groups
  estimate = "average",
  p_adjust = "holm"
)
```

