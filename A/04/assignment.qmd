---
title: "Lab 04: Data Processing for MLM"
subtitle: "PSYC 894 - Spring 2026"
format: 
  html:
    theme: cosmo
    toc: true
    number-sections: true
---

```{r}
#| include: false

library(tidyverse)
set.seed(2026)

# --- 1. Generate Level 2 Data (Patient Demographics) ---
n_patients <- 50
patient_info <- tibble(
  patient_id = paste0("P", 101:(100 + n_patients)),
  condition = sample(c("Control", "Treatment"), n_patients, replace = TRUE),
  age = sample(18:35, n_patients, replace = TRUE)
)

# --- 2. Generate Level 1 Data (Repeated Anxiety Scores) ---
# We create a wide structure: ID, wk1, wk2, wk3, wk4
anxiety_wide <- tibble(
  patient_id = patient_info$patient_id,
  anxiety_wk1 = round(rnorm(n_patients, mean = 25, sd = 5)),
  anxiety_wk2 = round(rnorm(n_patients, mean = 22, sd = 5)),
  anxiety_wk3 = round(rnorm(n_patients, mean = 20, sd = 5)),
  anxiety_wk4 = round(rnorm(n_patients, mean = 18, sd = 5))
)

# --- 3. Save Files ---
write_csv(patient_info, "patient_info.csv")
write_csv(anxiety_wide, "anxiety_wide.csv")
```

## Objective

The goal of this lab is to prepare data from a hypothetical clinical trial for multilevel modeling. You will demonstrate the skills covered in Lecture 04b, including:

* Reshaping "wide" data into "long" format.
* Parsing and cleaning variable names.
* Calculating cluster-level summaries (Split-Apply-Combine).
* Merging separate Level 1 and Level 2 data files.

## Data Source

Download the following two CSV files from Canvas and save them in your project folder:

1.  `anxiety_wide.csv`: Contains repeated anxiety scores for 50 patients over 4 weeks.
2.  `patient_info.csv`: Contains demographic information (Age and Treatment Condition) for those same patients.

## Instructions

### Setup and Inspection

Create a new Quarto document for your lab report. Load the `tidyverse` package and read in the two CSV files using `read_csv()`.

Inspect the `anxiety_wide` object. Note that it is currently in **wide** format: there is one row per patient, but the anxiety scores are spread across multiple columns (`anxiety_wk1`, `anxiety_wk2`, etc.). This format is unsuitable for MLM and must be reshaped.

### Reshape (Pivot)

Create a new object called `anxiety_long`. Use the `pivot_longer()` function to transform the wide anxiety data into **long** format.

* **Cols:** Select the columns that start with the string "anxiety".
* **Names:** Send the old column names to a new column called `"week"`.
* **Values:** Send the scores to a new column called `"anxiety"`.

### Clean the Data

Look at your new `week` column. It currently contains character strings (e.g., `"anxiety_wk1"`). 

Overwrite the `week` column using `mutate()` and `parse_number()` to convert these strings into clean numbers (e.g., `1`).

### Cluster-Level Summaries

We want to determine the **minimum** (best) anxiety score each patient reached during the study.

Use `mutate()` to add this as a new column called `min_score` to your long dataset. You must use the `.by` argument (or `group_by()`) to ensure this calculation happens *per patient* (`patient_id`). 

*(Hint: You can use the `min()` function to find the lowest score).*

### Merging Level 2 Data

The file `patient_info.csv` contains the study condition (Control vs. Treatment) for each person. This is Level 2 data.

Use `left_join()` to merge this demographic info into your `anxiety_long` dataset. Join the two tables by the `patient_id` column.

**Verification:** View your data to ensure the `condition` variable now appears for every time point (row) for each patient.

### Visualization

Use `ggplot()` to create a "spaghetti plot" of the study results:

* Map `week` to the x-axis and `anxiety` to the y-axis.
* Connect the data points with lines (`geom_line()`).
* Group the lines by `patient_id` so we see individual trajectories.
* Color the lines by `condition`.

**Interpretation Question:**
Based on your plot, does the Treatment group seem to improve (i.e., scores go down) faster than the Control group?
